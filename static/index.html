<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LlamaChat</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <style>
      :root {
        --primary-color: #10a37f;
        --primary-hover: #0d8c6f;
        --text-primary: #202123;
        --text-secondary: #6e6e80;
        --bg-primary: #ffffff;
        --bg-secondary: #f7f7f8;
        --border-color: #e5e5e5;
        --shadow-color: rgba(0, 0, 0, 0.05);
        --chat-user-bg: #f0f4f9;
        --chat-assistant-bg: var(--bg-primary);
        --chat-system-bg: #fffaeb;
        --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      }

      [data-theme="dark"] {
        --primary-color: #19c37d;
        --primary-hover: #19a169;
        --text-primary: #ececf1;
        --text-secondary: #acacbe;
        --bg-primary: #343541;
        --bg-secondary: #444654;
        --border-color: #4d4d4f;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --chat-user-bg: #444654;
        --chat-assistant-bg: #343541;
        --chat-system-bg: #3f3926;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-sans);
        background-color: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
        transition: background-color 0.3s, color 0.3s;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        max-width: 100vw;
        overflow-x: hidden;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        border-bottom: 1px solid var(--border-color);
        background-color: var(--bg-primary);
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .header-title {
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .theme-toggle,
      .clear-chat {
        background: none;
        border: none;
        font-size: 1.2rem;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 0.25rem;
        transition: color 0.2s, background-color 0.2s;
      }

      .theme-toggle:hover,
      .clear-chat:hover {
        color: var(--text-primary);
        background-color: var(--bg-secondary);
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        max-width: 1000px;
        width: 100%;
        margin: 0 auto;
        padding: 2rem 1rem;
      }

      #chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-bottom: 2rem;
        overflow-y: auto;
        padding-right: 0.5rem;
      }

      .message-wrapper {
        display: flex;
        flex-direction: column;
        width: 100%;
      }

      .message {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        border-radius: 0.5rem;
        max-width: 100%;
        line-height: 1.6;
      }

      .message-content {
        flex: 1;
      }

      .message-content p {
        margin-bottom: 1rem;
      }

      .message-content p:last-child {
        margin-bottom: 0;
      }

      .message-content pre {
        background-color: rgba(0, 0, 0, 0.05);
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin: 1rem 0;
      }

      .message-content code {
        font-family: "Menlo", "Monaco", "Courier New", monospace;
        font-size: 0.9rem;
      }

      [data-theme="dark"] .message-content pre {
        background-color: rgba(0, 0, 0, 0.3);
      }

      .avatar {
        width: 2rem;
        height: 2rem;
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
      }

      .avatar.user {
        background-color: var(--primary-color);
        color: white;
      }

      .avatar.assistant {
        background-color: #5436da;
        color: white;
      }

      .avatar.system {
        background-color: #f9a825;
        color: white;
      }

      .user {
        background-color: var(--chat-user-bg);
        align-self: flex-end;
      }

      .assistant {
        background-color: var(--chat-assistant-bg);
        align-self: flex-start;
        border: 1px solid var(--border-color);
      }

      .system {
        background-color: var(--chat-system-bg);
        align-self: flex-start;
        font-style: italic;
      }

      .controls {
        position: sticky;
        bottom: 0;
        padding: 1rem 0;
        background-color: var(--bg-primary);
        border-top: 1px solid var(--border-color);
      }

      .input-container {
        display: flex;
        flex-direction: column;
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        box-shadow: 0 2px 5px var(--shadow-color);
        overflow: hidden;
      }

      #user-input {
        flex: 1;
        padding: 1rem;
        border: none;
        resize: none;
        font-family: inherit;
        font-size: 1rem;
        background-color: transparent;
        color: var(--text-primary);
        min-height: 60px;
        max-height: 200px;
        outline: none;
      }

      .input-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        border-top: 1px solid var(--border-color);
      }

      .send-button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: background-color 0.2s;
      }

      .send-button:hover {
        background-color: var(--primary-hover);
      }

      .send-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .loading-dots {
        display: inline-flex;
        gap: 0.25rem;
        align-items: center;
        height: 1rem;
      }

      .loading-dots span {
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 50%;
        background-color: var(--text-secondary);
        opacity: 0.6;
        animation: loading 1.4s infinite ease-in-out both;
      }

      .loading-dots span:nth-child(1) {
        animation-delay: -0.32s;
      }

      .loading-dots span:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes loading {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      .typing-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }

      footer {
        text-align: center;
        padding: 1rem;
        color: var(--text-secondary);
        font-size: 0.85rem;
        border-top: 1px solid var(--border-color);
      }

      @media (max-width: 768px) {
        header {
          padding: 0.75rem 1rem;
        }

        main {
          padding: 1rem 0.5rem;
        }

        .message {
          padding: 0.75rem;
        }

        .controls {
          padding: 0.75rem 0;
        }
      }

      /* Code syntax highlighting overrides for dark mode */
      [data-theme="dark"] .hljs {
        background: rgba(0, 0, 0, 0.3);
        color: #e6e6e6;
      }

      [data-theme="dark"] .hljs-keyword,
      [data-theme="dark"] .hljs-selector-tag,
      [data-theme="dark"] .hljs-title,
      [data-theme="dark"] .hljs-section {
        color: #569cd6;
      }

      [data-theme="dark"] .hljs-string,
      [data-theme="dark"] .hljs-attr {
        color: #ce9178;
      }

      [data-theme="dark"] .hljs-comment {
        color: #6a9955;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-title">
        <i class="fas fa-comment-dots"></i>
        <span>LlamaChat</span>
      </div>
      <div class="header-actions">
        <button class="clear-chat" title="Clear conversation">
          <i class="fas fa-trash-alt"></i>
        </button>
        <button class="theme-toggle" title="Toggle dark mode">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </header>

    <main>
      <div id="chat-container"></div>
      <div class="controls">
        <div class="input-container">
          <textarea
            id="user-input"
            placeholder="Type your message..."
            rows="1"
          ></textarea>
          <div class="input-buttons">
            <div></div>
            <button id="send-button" class="send-button">
              <span>Send</span>
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>
        Powered by Meta-Llama 3.2 â€¢
        <a href="https://github.com/meta-llama/llama" target="_blank"
          >Learn more</a
        >
      </p>
    </footer>

    <script>
      // We'll keep the entire conversation in an array of { role: "system"|"user"|"assistant", content: "..." }
      let conversation = [
        // Initial system prompt
        {
          role: "system",
          content:
            "You are a helpful assistant. You provide concise, accurate answers.",
        },
      ];

      let isWaitingForResponse = false;
      const chatContainer = document.getElementById("chat-container");
      const userInput = document.getElementById("user-input");
      const sendButton = document.getElementById("send-button");
      const clearChatButton = document.querySelector(".clear-chat");
      const themeToggleButton = document.querySelector(".theme-toggle");

      // Check for saved theme preference
      if (
        localStorage.getItem("theme") === "dark" ||
        (window.matchMedia("(prefers-color-scheme: dark)").matches &&
          !localStorage.getItem("theme"))
      ) {
        document.documentElement.setAttribute("data-theme", "dark");
        themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
      }

      // Initialize markdown renderer with code highlighting
      marked.setOptions({
        highlight: function (code, lang) {
          if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
          }
          return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true,
      });

      // Auto-resize textarea
      userInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height =
          (this.scrollHeight < 200 ? this.scrollHeight : 200) + "px";
      });

      // Send message on Enter (but allow Shift+Enter for newlines)
      userInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      });

      // Theme toggle
      themeToggleButton.addEventListener("click", function () {
        if (document.documentElement.getAttribute("data-theme") === "dark") {
          document.documentElement.removeAttribute("data-theme");
          localStorage.setItem("theme", "light");
          this.innerHTML = '<i class="fas fa-moon"></i>';
        } else {
          document.documentElement.setAttribute("data-theme", "dark");
          localStorage.setItem("theme", "dark");
          this.innerHTML = '<i class="fas fa-sun"></i>';
        }
      });

      // Clear chat
      clearChatButton.addEventListener("click", function () {
        if (confirm("Are you sure you want to clear this conversation?")) {
          conversation = [
            {
              role: "system",
              content:
                "You are a helpful assistant. You provide concise, accurate answers.",
            },
          ];
          chatContainer.innerHTML = "";
          renderConversation();
        }
      });

      // Send button click
      sendButton.addEventListener("click", sendMessage);

      // Format code blocks in text
      function formatCodeBlocks(text) {
        return marked.parse(text);
      }

      // Render the entire conversation
      function renderConversation() {
        chatContainer.innerHTML = "";
        conversation.forEach((msg, index) => {
          renderMessage(msg, index);
        });
        // Scroll to bottom
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Render a single message
      function renderMessage(msg, index) {
        const msgWrapper = document.createElement("div");
        msgWrapper.classList.add("message-wrapper");
        msgWrapper.id = "msg-wrapper-" + index;

        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message", msg.role);
        msgDiv.id = "msg-" + index;

        // Create avatar
        const avatar = document.createElement("div");
        avatar.classList.add("avatar", msg.role);

        if (msg.role === "system") {
          avatar.innerHTML = '<i class="fas fa-cog"></i>';
        } else if (msg.role === "user") {
          avatar.innerHTML = '<i class="fas fa-user"></i>';
        } else {
          avatar.innerHTML = '<i class="fas fa-robot"></i>';
        }

        // Create content wrapper
        const contentDiv = document.createElement("div");
        contentDiv.classList.add("message-content");

        // Process content with markdown and code highlighting
        if (msg.content.trim()) {
          contentDiv.innerHTML = formatCodeBlocks(msg.content);
        } else {
          contentDiv.innerHTML =
            '<div class="typing-indicator">Typing<div class="loading-dots"><span></span><span></span><span></span></div></div>';
        }

        msgDiv.appendChild(avatar);
        msgDiv.appendChild(contentDiv);
        msgWrapper.appendChild(msgDiv);
        chatContainer.appendChild(msgWrapper);
      }

      // Render initial conversation
      renderConversation();

      async function sendMessage() {
        const text = userInput.value.trim();
        if (!text || isWaitingForResponse) return;

        // Disable input and button while waiting
        isWaitingForResponse = true;
        userInput.disabled = true;
        sendButton.disabled = true;
        sendButton.innerHTML =
          '<div class="loading-dots"><span></span><span></span><span></span></div>';

        // Add the user's message
        conversation.push({ role: "user", content: text });
        userInput.value = "";
        userInput.style.height = "auto";

        // Re-render to show the user message
        renderConversation();

        try {
          // Prepare request to the server
          const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(conversation),
          });

          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }

          // Add a placeholder for the assistant's new message
          let assistantMessage = { role: "assistant", content: "" };
          conversation.push(assistantMessage);

          // Re-render to add the assistant's message placeholder
          renderConversation();

          // We'll update the last message's DOM element in real-time
          const assistantIndex = conversation.length - 1;
          const assistantContentDiv = document.querySelector(
            `#msg-${assistantIndex} .message-content`
          );

          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            // Convert chunk to string
            const chunk = decoder.decode(value, { stream: true });

            // Append chunk to assistant's message
            assistantMessage.content += chunk;

            // Update only the message content with markdown formatting
            assistantContentDiv.innerHTML = formatCodeBlocks(
              assistantMessage.content
            );

            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }

          // Highlight any code blocks
          document.querySelectorAll("pre code").forEach((block) => {
            hljs.highlightElement(block);
          });
        } catch (error) {
          console.error("Error:", error);

          // Add error message to the conversation
          conversation.push({
            role: "system",
            content:
              "An error occurred while communicating with the server. Please try again later.",
          });
          renderConversation();
        } finally {
          // Re-enable input and button
          isWaitingForResponse = false;
          userInput.disabled = false;
          sendButton.disabled = false;
          sendButton.innerHTML =
            '<span>Send</span><i class="fas fa-paper-plane"></i>';
          userInput.focus();
        }
      }
    </script>
  </body>
</html>
